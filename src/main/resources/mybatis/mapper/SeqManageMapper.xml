<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitedu.bipa.simplesignbackend.mapper.SeqManageMapper">

    <select id="getSeqAndCompList" resultType="bitedu.bipa.simplesignbackend.model.dto.SeqAndCompDTO">
        SELECT seq_code AS id, comp_name, seq_code AS code, seq_name, seq_description AS description FROM sequence
        INNER JOIN company ON sequence.comp_id = company.comp_id
        WHERE sequence.comp_id=#{compId} AND seq_name like CONCAT('%', #{seqName}, '%') AND seq_code like CONCAT('%', #{code}, '%') AND seq_del_status=0;
    </select>

    <select id="getSeqDetail" resultType="bitedu.bipa.simplesignbackend.model.dto.SeqDetailDTO">
        select seq_code AS code, seq_name, Seq_description as description, seq_sort_order as sortOrder, product_form AS seqString, comp_id
        from sequence where seq_code=#{code};
    </select>

    <select id="selectSeqItems" resultType="java.lang.String">
        SELECT GROUP_CONCAT(code_value SEPARATOR ' ') FROM (
        <foreach collection="seqItems" item="seqItem" separator="UNION ALL">
            SELECT code_value FROM common_code WHERE section_id="005" AND code_id=#{seqItem}
        </foreach>) AS result
    </select>

    <select id="getSeqDeptScope" resultType="bitedu.bipa.simplesignbackend.model.dto.SeqScopeDTO">
        SELECT A.status AS category, A.seq_code, A.use_id, comp.comp_id, comp.comp_name AS company, est.est_id, IFNULL(est.est_name, "") AS establishment, dept.dept_id, IFNULL(dept.dept_name, "") AS department, user.user_id, IFNULL(user.user_name, "") AS user, IFNULL(user.grade_name, "") AS grade, IFNULL(user.position_name, "") AS position
        FROM (SELECT * FROM sequence_use_department WHERE seq_code=#{code}) A
        LEFT JOIN (SELECT user.user_id, user.user_name, ou.dept_id, g.grade_name, p.position_name FROM user
        INNER JOIN organization_user AS ou ON user.user_id=ou.org_user_id
        INNER JOIN grade AS g on ou.grade_code=g.grade_code
        INNER JOIN position AS p on ou.position_code=p.position_code) AS user ON A.status = 'U' AND A.use_id = user.user_id
        LEFT JOIN department AS dept ON A.status IN ('U', 'D') AND (A.use_id= dept.dept_id)
        LEFT JOIN establishment AS est ON A.status IN ('U', 'D', 'E') AND (A.use_id= est.est_id)
        LEFT JOIN company AS comp ON A.status IN ('U', 'D', 'E', 'C') AND (A.use_id= comp.comp_id);
    </select>

    <select id="getSeqFormScope" resultType="bitedu.bipa.simplesignbackend.model.dto.SeqScopeDTO">
        SELECT "F" AS category, fl.form_code AS useId, form_name AS name FROM (SELECT form_code FROM sequence_use_form WHERE seq_code=#{code}) fl
        LEFT JOIN form ON fl.form_code = form.form_code;
    </select>

    <update id="deleteSeq">
        UPDATE sequence SET seq_del_status=1 WHERE seq_code = #{code}
    </update>

    <insert id="createSeqDetail" >
        INSERT INTO sequence(comp_id, seq_name, seq_description, seq_sort_order, product_form)
        VALUES(#{compId}, #{seqName}, #{description}, #{sortOrder}, #{seqString});
    </insert>

    <insert id="createSeqDeptScope" parameterType="map">
        INSERT INTO sequence_use_department(status, seq_code, use_id) VALUES(#{category}, #{seqCode}, #{useId});
    </insert>

    <insert id="createSeqFormScope" parameterType="map">
        INSERT INTO sequence_use_form(form_code, seq_code) VALUES(#{formCode}, #{seqCode});
    </insert>

    <update id="updateSeqDetail" >
        UPDATE sequence SET
        seq_name=#{seqName},
        seq_description=#{description},
        seq_sort_order=#{sortOrder},
        product_form=#{seqString}
        WHERE seq_code=#{code};
    </update>

    <delete id="delDeptScope">
        delete from sequence_use_department
        where status=#{category} and seq_code = #{seqCode} and use_id = #{useId}
    </delete>

    <insert id="insertIgnoreDeptScope" parameterType="map">
        INSERT IGNORE INTO sequence_use_department(status, seq_code, use_id)
        VALUES(#{category}, #{seqCode}, #{useId});
    </insert>

    <delete id="delFormScope">
        delete from sequence_use_form
        where seq_code = #{seqCode} and form_code = #{formCode}
    </delete>

    <insert id="insertIgnoreFormScope" parameterType="map">
        INSERT IGNORE INTO sequence_use_form(form_code, seq_code)
        VALUES(#{formCode}, #{seqCode});
    </insert>
</mapper>