<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitedu.bipa.simplesignbackend.mapper.ApprovalBoxMapper">
    <select id="getDocumentsByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        <choose>
            <when test="viewItems.contains('reference')">
                SELECT
                ad.approval_doc_id, ad.product_num, ad.approval_doc_title, ad.approval_date as sendDate,
                u.user_name, ad.doc_status, ou.dept_name, ad.form_name,
                ad.end_at as end_date, u2.user_name as last_user, a.approval_date, a.receive_date
                FROM approval_doc ad ignore index(primary)
            </when>
            <otherwise>
                SELECT
                ad.approval_doc_id, ad.product_num, ad.approval_doc_title, ad.approval_date as sendDate,
                u.user_name, ad.doc_status, ou.dept_name, ad.form_name,
                ad.end_at as end_date, u2.user_name as last_user, a.approval_date, a.receive_date
                FROM approval_doc ad
            </otherwise>
        </choose>


        <!-- 로그인 사용자에 대한 결재 테이블 join (미결, 기결, 기결진행, 기결종결)-->
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        <!-- 상신자 이름 들고오기 join -->
        JOIN organization_user ou ON ou.org_user_id = ad.org_user_id
        LEFT JOIN user u ON  ou.user_id = u.user_id
        <!-- 마지막 결재자를 들고오기 위한 join -->
        LEFT JOIN approval a2 ON (ad.approval_doc_id = a2.approval_doc_id
        AND a2.approval_order = (
        SELECT MAX(sub_a.approval_order)
        FROM approval sub_a
        JOIN approval_doc ad2 ON ad2.approval_doc_id = sub_a.approval_doc_id
        JOIN organization_user ou3 ON ou3.org_user_id = sub_a.org_user_id
        WHERE ad2.approval_doc_id = ad.approval_doc_id
        AND ou3.org_user_id = sub_a.org_user_id
        AND sub_a.approval_status in ('A','R'))
        )
        LEFT JOIN organization_user ou2 ON ou2.org_user_id = a2.org_user_id
        LEFT JOIN user u2 ON ou2.user_id = u2.user_id

        <!-- 수신참조함 join -->
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
                left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
            </if>
        </foreach>
        <!-- 문서함에 따른 where 절 -->
        WHERE (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.doc_status != 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'tempor'">
                (ad.doc_status = 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'pend'">
                (ad.doc_status in ('P','W') AND a.org_user_id = #{orgUserId} AND a.approval_status = 'P')
            </if>
            <if test="viewItem == 'concluded'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (
                (r.use_id = #{orgUserId} AND r.category = 'U')
                OR (r.use_id = #{deptId} AND r.category = 'D')
                OR (r.use_id = #{estId} AND r.category= 'E')
                OR (r.use_id = #{compId} AND r.category = 'C')
                )
            </if>
            <if test="viewItem == 'progress'">
                (ad.doc_status = 'P' AND a.org_user_id = #{orgUserId} AND a.approval_status IN ('A', 'R'))
            </if>
            <if test="viewItem == 'end'">
                (ad.doc_status IN ('A', 'R') AND a.org_user_id =#{orgUserId})
            </if>
            <if test="viewItem == 'reject'">
                (ad.doc_status = 'R' AND ad.org_user_id = #{orgUserId})
            </if>
        </foreach>
        )
        and ad.doc_del_status = 0

        <!-- 문서 필터링 정렬 -->
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>
                    <otherwise>

                    </otherwise>
                </choose>
            </when>
        </choose>

        <if test="lastApprovalDate != null and lastApprovalDocId != null">
            <!-- 내림차순 정렬일 때 -->
            <choose>
                <when test="sortStatus == 'desc'">
                    AND (#{lastApprovalDate} > ad.approval_date OR (ad.approval_date = #{lastApprovalDate} AND #{lastApprovalDocId} > ad.approval_doc_id))
                </when>
                <!-- 오름차순 정렬일 때 -->
                <when test="sortStatus == 'asc'">
                    AND (ad.approval_date > #{lastApprovalDate} OR (ad.approval_date = #{lastApprovalDate} AND ad.approval_doc_id > #{lastApprovalDocId}))
                </when>
            </choose>
        </if>

        <!-- 오름차순/내림차순 -->
        <choose>
            <when test="sortStatus == 'asc'">
                ORDER BY ad.approval_date ASC, ad.approval_doc_id ASC
            </when>
            <when test="sortStatus == 'desc'">
                ORDER BY ad.approval_date DESC, ad.approval_doc_id DESC
            </when>
        </choose>



        LIMIT #{itemsPerPage};
    </select>





    <select id="getDocCountByViewItems" resultType="int">
        SELECT COUNT(*)
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        <!-- 수신참조함 join -->
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
                left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
            </if>
        </foreach>
        <!-- 문서함에 따른 where 절 -->
        WHERE (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.doc_status != 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'tempor'">
                (ad.doc_status = 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'pend'">
                (ad.doc_status in ('P','W') AND a.org_user_id = #{orgUserId} AND a.approval_status = 'P')
            </if>
            <if test="viewItem == 'concluded'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (ad.doc_status NOT IN ('T', 'P')
                AND (
                (r.approval_doc_id = ad.approval_doc_id AND r.use_id = #{orgUserId} AND r.category = 'U')
                OR (r.use_id = #{deptId} AND r.category = 'D')
                OR (r.use_id = #{compId} AND r.category = 'C')
                ))
            </if>
            <if test="viewItem == 'progress'">
                (ad.doc_status = 'P' AND a.org_user_id = #{orgUserId} AND a.approval_status IN ('A', 'R'))
            </if>
            <if test="viewItem == 'end'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R') and ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.doc_status = 'R' AND ad.org_user_id = #{orgUserId})
            </if>
        </foreach>
        )
        and ad.doc_del_status = 0

        <!-- 문서 필터링 정렬 -->
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>
                    <otherwise>

                    </otherwise>
                </choose>
            </when>
        </choose>
    </select>


    <select id="getSearchDocumentsByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT
        ad.approval_doc_id, ad.product_num, ad.approval_doc_title, ad.approval_date as sendDate,
        u.user_name, ad.doc_status, ou.dept_name, ad.form_name,
        ad.end_at as end_date, u2.user_name as last_user, a.approval_date, a.receive_date
        FROM approval_doc ad


        <!-- 로그인 사용자에 대한 결재 테이블 join (미결, 기결, 기결진행, 기결종결)-->
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        <!-- 상신자 이름 들고오기 join -->
        JOIN organization_user ou ON ou.org_user_id = ad.org_user_id
        LEFT JOIN user u ON  ou.user_id = u.user_id
        <!-- 마지막 결재자를 들고오기 위한 join -->
        LEFT JOIN approval a2 ON (ad.approval_doc_id = a2.approval_doc_id
        AND a2.approval_order = (
        SELECT MAX(sub_a.approval_order)
        FROM approval sub_a
        JOIN approval_doc ad2 ON ad2.approval_doc_id = sub_a.approval_doc_id
        JOIN organization_user ou3 ON ou3.org_user_id = sub_a.org_user_id
        WHERE ad2.approval_doc_id = ad.approval_doc_id
        AND ou3.org_user_id = sub_a.org_user_id
        AND sub_a.approval_status in ('A','R'))
        )
        LEFT JOIN organization_user ou2 ON ou2.org_user_id = a2.org_user_id
        LEFT JOIN user u2 ON ou2.user_id = u2.user_id

        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem != 'tempor'">
                join search_contents sc on sc.approval_doc_id = ad.approval_doc_id
            </if>
        </foreach>


        <!-- 수신참조함 join -->
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
                left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
            </if>
        </foreach>
        <!-- 문서함에 따른 where 절 -->
        WHERE (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.doc_status != 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'tempor'">
                (ad.doc_status = 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'pend'">
                (ad.doc_status in ('P','W') AND a.org_user_id = #{orgUserId} AND a.approval_status = 'P')
            </if>
            <if test="viewItem == 'concluded'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (
                (r.use_id = #{orgUserId} AND r.category = 'U')
                OR (r.use_id = #{deptId} AND r.category = 'D')
                OR (r.use_id = #{estId} AND r.category= 'E')
                OR (r.use_id = #{compId} AND r.category = 'C')
                )
            </if>
            <if test="viewItem == 'progress'">
                (ad.doc_status = 'P' AND a.org_user_id = #{orgUserId} AND a.approval_status IN ('A', 'R'))
            </if>
            <if test="viewItem == 'end'">
                (ad.doc_status IN ('A', 'R') AND a.org_user_id =#{orgUserId})
            </if>
            <if test="viewItem == 'reject'">
                (ad.doc_status = 'R' AND ad.org_user_id = #{orgUserId})
            </if>
        </foreach>
        )
        and ad.doc_del_status = 0

        <!-- 문서 필터링 정렬 -->
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>
                    <otherwise>

                    </otherwise>
                </choose>
            </when>
        </choose>
        AND (
        ad.approval_doc_title LIKE CONCAT('%', #{searchInput}, '%')

        <if test="inputFormCode != null">
            <foreach item="item" index="index" collection="inputFormCode"
                     open="OR (" separator="OR" close=")">
                ad.form_code = #{item}
            </foreach>
        </if>
        <if test="inputOrgUserId != null">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="OR (" separator="OR" close=")">
                ou.org_user_id = #{item}
            </foreach>
        </if>
        <if test="inputOrgUserId != null">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="OR (" separator="OR" close=")">
                ou2.org_user_id = #{item}
            </foreach>
        </if>

        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem != 'tempor'">
                OR sc.contents LIKE CONCAT('%', #{searchInput}, '%')
            </if>
        </foreach>

        or ad.product_num LIKE CONCAT('%', #{searchInput}, '%')
        )


        <if test="lastApprovalDate != null and lastApprovalDocId != null">
            <!-- 내림차순 정렬일 때 -->
            <choose>
                <when test="sortStatus == 'desc'">
                    AND (#{lastApprovalDate} > ad.approval_date OR (ad.approval_date = #{lastApprovalDate} AND #{lastApprovalDocId} > ad.approval_doc_id))
                </when>
                <!-- 오름차순 정렬일 때 -->
                <when test="sortStatus == 'asc'">
                    AND (ad.approval_date > #{lastApprovalDate} OR (ad.approval_date = #{lastApprovalDate} AND ad.approval_doc_id > #{lastApprovalDocId}))
                </when>
            </choose>
        </if>

        <!-- 오름차순/내림차순 -->
        <choose>
            <when test="sortStatus == 'asc'">
                ORDER BY ad.approval_date ASC, ad.approval_doc_id ASC
            </when>
            <when test="sortStatus == 'desc'">
                ORDER BY ad.approval_date DESC, ad.approval_doc_id DESC
            </when>
        </choose>

        LIMIT #{itemsPerPage};
    </select>

    <select id="getSearchDocCountByViewItems" resultType="int">
        SELECT COUNT(DISTINCT ad.approval_doc_id)
        FROM approval_doc ad
        <!-- 로그인 사용자에 대한 결재 테이블 join (미결, 기결, 기결진행, 기결종결)-->
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        <!-- 상신자 이름 들고오기 join -->
        JOIN organization_user ou ON ou.org_user_id = ad.org_user_id
        LEFT JOIN user u ON  ou.user_id = u.user_id
        <!-- 마지막 결재자를 들고오기 위한 join -->
        LEFT JOIN approval a2 ON (ad.approval_doc_id = a2.approval_doc_id
        AND a2.approval_order = (
        SELECT MAX(sub_a.approval_order)
        FROM approval sub_a
        JOIN approval_doc ad2 ON ad2.approval_doc_id = sub_a.approval_doc_id
        JOIN organization_user ou3 ON ou3.org_user_id = sub_a.org_user_id
        WHERE ad2.approval_doc_id = ad.approval_doc_id
        AND ou3.org_user_id = sub_a.org_user_id
        AND sub_a.approval_status in ('A','R'))
        )
        LEFT JOIN organization_user ou2 ON ou2.org_user_id = a2.org_user_id
        LEFT JOIN user u2 ON ou2.user_id = u2.user_id

        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem != 'tempor'">
                join search_contents sc on sc.approval_doc_id = ad.approval_doc_id
            </if>
        </foreach>


        <!-- 수신참조함 join -->
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
                left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
            </if>
        </foreach>
        <!-- 문서함에 따른 where 절 -->
        WHERE (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.doc_status != 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'tempor'">
                (ad.doc_status = 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'pend'">
                (ad.doc_status in ('P','W') AND a.org_user_id = #{orgUserId} AND a.approval_status = 'P')
            </if>
            <if test="viewItem == 'concluded'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (
                (r.use_id = #{orgUserId} AND r.category = 'U')
                OR (r.use_id = #{deptId} AND r.category = 'D')
                OR (r.use_id = #{estId} AND r.category= 'E')
                OR (r.use_id = #{compId} AND r.category = 'C')
                )
            </if>
            <if test="viewItem == 'progress'">
                (ad.doc_status = 'P' AND a.org_user_id = #{orgUserId} AND a.approval_status IN ('A', 'R'))
            </if>
            <if test="viewItem == 'end'">
                (ad.doc_status IN ('A', 'R') AND a.org_user_id =#{orgUserId})
            </if>
            <if test="viewItem == 'reject'">
                (ad.doc_status = 'R' AND ad.org_user_id = #{orgUserId})
            </if>
        </foreach>
        )
        and ad.doc_del_status = 0

        <!-- 문서 필터링 정렬 -->
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>
                    <otherwise>

                    </otherwise>
                </choose>
            </when>
        </choose>
        AND (
        ad.approval_doc_title LIKE CONCAT('%', #{searchInput}, '%')



        <if test="inputFormCode != null">
            <foreach item="item" index="index" collection="inputFormCode"
                     open="OR (" separator="OR" close=")">
                ad.form_code = #{item}
            </foreach>
        </if>
        <if test="inputOrgUserId != null">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="OR (" separator="OR" close=")">
                ou.org_user_id = #{item}
            </foreach>
        </if>
        <if test="inputOrgUserId != null">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="OR (" separator="OR" close=")">
                ou2.org_user_id = #{item}
            </foreach>
        </if>

        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem != 'tempor'">
                OR sc.contents LIKE CONCAT('%', #{searchInput}, '%')
            </if>
        </foreach>

        or ad.product_num LIKE CONCAT('%', #{searchInput}, '%')
        )
    </select>

    <sql id="commonIfConditions">
        <if test="criteria.searchDocForm != null and criteria.searchDocForm != ''">
            <foreach item="item" index="index" collection="inputFormCode"
                     open="and (" separator="or" close=")">
                ad.form_code = #{item}
            </foreach>
        </if>
        <if test="criteria.searchDept != null and criteria.searchDept != ''">
            <foreach item="item" index="index" collection="inputDeptId"
                     open="and (" separator="or" close=")">
                ou.dept_name = #{item}
            </foreach>
        </if>
        <if test="criteria.searchWriter != null and criteria.searchWriter != ''">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="and (" separator="OR" close=")">
                ou.org_user_id = #{item}
            </foreach>
        </if>
        <if test="criteria.searchApprovUser != null and criteria.searchApprovUser != ''">
            <foreach item="item" index="index" collection="inputOrgUserId"
                     open="and (" separator="OR" close=")">
                ou2.org_user_id = #{item}
            </foreach>
        </if>
        <if test="criteria.searchApprovState != null and criteria.searchApprovState != ''">
            <choose>
                <when test="criteria.searchApprovState == 2"  >
                    AND ad.doc_status = 'W'
                </when>
                <when test="criteria.searchApprovState == 3">
                    AND ad.doc_status = 'P'
                </when>
                <when test="criteria.searchApprovState == 4">
                    AND ad.doc_status IN ('A', 'R')
                </when>
                <when test="criteria.searchApprovState == 5">
                    AND ad.doc_status = 'R'
                </when>
            </choose>
        </if>
        <if test="criteria.startDate != null and criteria.endDate != null">
            <choose>
                <when test="criteria.searchDate == 1"  >
                    AND (ad.approval_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 2">
                    AND (a.user_id=#{orgUserId} AND a.receive_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 3">
                    AND (a.approval_status IN('A','R') AND a.approval_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 4">
                    AND (ad.end_at BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
            </choose>
        </if>
        <if test="criteria.searchTitle != null and criteria.searchTitle != ''">
            AND MATCH(sc.approval_doc_title) AGAINST(#{criteria.searchTitle})
        </if>
        <if test="criteria.searchContent != null and criteria.searchContent != ''">
            AND MATCH(sc.contents) AGAINST(#{criteria.searchContent})
        </if>
        <if test="criteria.searchDocNumber > 0">
            AND sc.product_num LIKE CONCAT('%', #{criteria.searchDocNumber}, '%')
        </if>
    </sql>

    <select id="getDetailSearchDocsList" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">

        <choose>
            <when test="viewItems.contains('concluded')">
                SELECT
                ad.approval_doc_id, ad.product_num,  ad.approval_doc_title, ad.approval_date as sendDate,
                u.user_name, ad.doc_status, ou.dept_name, ad.form_name,
                ad.end_at as end_date, u2.user_name as last_user, a.approval_date, a.receive_date
                FROM approval_doc ad
            </when>

            <otherwise>
                SELECT
                ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate,
                u.user_name, ad.doc_status, ou.dept_name, ad.form_name,
                ad.end_at as end_date, u2.user_name as last_user, a.approval_date, a.receive_date
                FROM approval_doc ad ignore index(approval_date_idx)
            </otherwise>
        </choose>


        <!-- 로그인 사용자에 대한 결재 테이블 join (미결, 기결, 기결진행, 기결종결)-->
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        <!-- 상신자 이름 들고오기 join -->
        JOIN organization_user ou ON ou.org_user_id = ad.org_user_id
        LEFT JOIN user u ON  ou.user_id = u.user_id
        <!-- 마지막 결재자를 들고오기 위한 join -->
        LEFT JOIN approval a2 ON (ad.approval_doc_id = a2.approval_doc_id
        AND a2.approval_order = (
        SELECT MAX(sub_a.approval_order)
        FROM approval sub_a
        JOIN approval_doc ad2 ON ad2.approval_doc_id = sub_a.approval_doc_id
        JOIN organization_user ou3 ON ou3.org_user_id = sub_a.org_user_id
        WHERE ad2.approval_doc_id = ad.approval_doc_id
        AND ou3.org_user_id = sub_a.org_user_id
        AND sub_a.approval_status in ('A','R'))
        )
        LEFT JOIN organization_user ou2 ON ou2.org_user_id = a2.org_user_id
        LEFT JOIN user u2 ON ou2.user_id = u2.user_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem != 'tempor'">
                join search_contents sc on sc.approval_doc_id = ad.approval_doc_id
            </if>
        </foreach>


        <!-- 수신참조함 join -->
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
                left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
            </if>
        </foreach>

        <!-- 문서함에 따른 where 절 -->
        WHERE (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.doc_status != 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'tempor'">
                (ad.doc_status = 'T' AND ad.org_user_id = #{orgUserId})
            </if>
            <if test="viewItem == 'pend'">
                (ad.doc_status in ('P','W') AND a.org_user_id = #{orgUserId} AND a.approval_status = 'P')
            </if>
            <if test="viewItem == 'concluded'">
                (ad.doc_status IN ('A', 'R', 'P') AND a.org_user_id = #{orgUserId} AND a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (
                (r.use_id = #{orgUserId} AND r.category = 'U')
                OR (r.use_id = #{deptId} AND r.category = 'D')
                OR (r.use_id = #{estId} AND r.category= 'E')
                OR (r.use_id = #{compId} AND r.category = 'C')
                )
            </if>
            <if test="viewItem == 'progress'">
                (ad.doc_status = 'P' AND a.org_user_id = #{orgUserId} AND a.approval_status IN ('A', 'R'))
            </if>
            <if test="viewItem == 'end'">
                (ad.doc_status IN ('A', 'R') AND a.org_user_id =#{orgUserId})
            </if>
            <if test="viewItem == 'reject'">
                (ad.doc_status = 'R' AND ad.org_user_id = #{orgUserId})
            </if>
        </foreach>
        )
        <include refid="commonIfConditions"/>

        and ad.doc_del_status = 0

        <!-- 문서 필터링 정렬 -->
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>
                    <otherwise>

                    </otherwise>
                </choose>
            </when>
        </choose>



        <if test="lastApprovalDate != null and lastApprovalDocId != null">
            <!-- 내림차순 정렬일 때 -->
            <choose>
                <when test="sortStatus == 'desc'">
                    AND (#{lastApprovalDate} > ad.approval_date OR (ad.approval_date = #{lastApprovalDate} AND #{lastApprovalDocId} > ad.approval_doc_id))
                </when>
                <!-- 오름차순 정렬일 때 -->
                <when test="sortStatus == 'asc'">
                    AND (ad.approval_date > #{lastApprovalDate} OR (ad.approval_date = #{lastApprovalDate} AND ad.approval_doc_id > #{lastApprovalDocId}))
                </when>
            </choose>
        </if>

        <!-- 오름차순/내림차순 -->
        <choose>
            <when test="sortStatus == 'asc'">
                ORDER BY ad.approval_date ASC, ad.approval_doc_id ASC
            </when>
            <when test="sortStatus == 'desc'">
                ORDER BY ad.approval_date DESC, ad.approval_doc_id DESC
            </when>
        </choose>



        LIMIT #{itemsPerPage};


    </select>

    <select id="getDetailSearchDocsCount" resultType="int">
        SELECT COUNT(DISTINCT ad.approval_doc_id)
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id and a.org_user_id =#{orgUserId}
        JOIN organization_user ou ON ou.org_user_id = ad.org_user_id
        LEFT JOIN approval a2 ON (ad.approval_doc_id = a2.approval_doc_id
        AND a2.approval_order = (
        SELECT MAX(sub_a.approval_order)
        FROM approval sub_a
        JOIN approval_doc ad2 ON ad2.approval_doc_id = sub_a.approval_doc_id
        JOIN organization_user ou3 ON ou3.org_user_id = sub_a.org_user_id
        WHERE ad2.approval_doc_id = ad.approval_doc_id
        AND ou3.org_user_id = sub_a.org_user_id
        AND sub_a.approval_status in ('A','R')

        ))
        left JOIN organization_user ou2 ON ou2.org_user_id = a2.org_user_id
        LEFT JOIN user u ON (ad.org_user_id = ou.org_user_id and ou.user_id = u.user_id)
        LEFT JOIN user u2 ON (a2.org_user_id = ou2.org_user_id and ou2.user_id = u2.user_id)
        JOIN department d ON d.dept_id = ou.dept_id
        JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                left join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{orgUserId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{orgUserId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{orgUserId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R' and ad.doc_status !=
                'T'))</if>
            <if test="viewItem == 'concluded'">
                (a.org_user_id = #{orgUserId} AND ad.doc_status IN ('A', 'R', 'P') and a.approval_status in('A','R'))
            </if>
            <if test="viewItem == 'reference'">
                (ad.doc_status != 'T' and ad.doc_status != 'P' and r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{orgUserId} and r.category = 'U') OR (r.use_id =#{deptId}  and r.category='D') OR (r.use_id = #{estId}  and r.category='E') OR (r.use_id = #{compId}  and r.category='C'))
            </if>
            <if test="viewItem == 'progress'">
                ((a.org_user_id = #{orgUserId} AND ad.doc_status = 'P' AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (a.org_user_id = #{orgUserId} AND ad.doc_status IN ('A', 'R', 'P') and a.approval_status in('A','R') and end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{orgUserId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{orgUserId}))
            </if>
        </foreach>
        )
        <choose>
            <when test="radioSortValue != null and radioSortValue != ''">
                <choose>
                    <when test="radioSortValue=='ongoingdoc'">
                        and ad.doc_status = 'P'
                    </when>
                    <when test="radioSortValue=='writtendoc'">
                        and ad.doc_status in ('A','R')
                    </when>
                    <when test="radioSortValue=='notreaddoc'">
                        and (dv.org_user_id != #{orgUserId} OR dv.org_user_id IS NULL)
                    </when>
                    <when test="radioSortValue=='readdoc'">
                        and dv.org_user_id = #{orgUserId}
                    </when>

                </choose>
            </when>
        </choose>
        <include refid="commonIfConditions"/>;
    </select>

    <select id="selectSendCount" resultType="int">
        select count(*) from approval_doc where org_user_id = #{orgUserId} and doc_status = 'P' and doc_del_status = 0
    </select>
    <select id="selectPendCount" resultType="int">
        select count(*) from approval_doc ad
        join approval a on a.approval_doc_id = ad.approval_doc_id
        where a.org_user_id = #{orgUserId} and a.approval_status = 'P' and doc_del_status = 0 and (ad.doc_status != 'A' and ad.doc_status != 'R' and ad.doc_status != 'T')
    </select>
    <select id="selectConcludedCount" resultType="int">
        select count(*) from approval_doc ad
        join approval a on a.approval_doc_id = ad. approval_doc_id
        where a.org_user_id = #{orgUserId} and (a.approval_status = 'A' or a.approval_status = 'R') and doc_del_status = 0
        and ad.doc_status = 'P'
    </select>
    <select id="selectReferenceCount" resultType="int">
        SELECT COUNT(*) FROM (
        SELECT ad.approval_doc_id
        FROM approval_doc ad
        join received_ref r on (r.active_state = 1 and r.approval_doc_id = ad.approval_doc_id)
        left join doc_view dv on (dv.approval_doc_id = ad.approval_doc_id and dv.org_user_id = #{orgUserId})
        WHERE (
        (
        (r.use_id = #{orgUserId} AND r.category = 'U') OR
        (r.use_id = #{deptId} AND r.category = 'D') OR
        (r.use_id = #{compId} AND r.category = 'C')
        ))
        AND ad.doc_del_status = 0
        AND dv.approval_doc_id IS NULL
        ) as subquery;

    </select>
    <insert id="insertDocView">
        INSERT INTO doc_view(approval_doc_id, org_user_id)
        SELECT #{docId}, #{orgUserId}
        WHERE NOT EXISTS (
        SELECT 1
        FROM doc_view
        WHERE approval_doc_id = #{docId} AND org_user_id = #{orgUserId}
        )
    </insert>
    <select id="selectDocView"  resultType="java.lang.Integer">
        select approval_doc_id from doc_view where org_user_id = #{orgUserId}
    </select>
    <select id="selectOrgUserId"  resultType="java.lang.Integer">
        select org_user_id from organization_user
        join user on organization_user.user_id = user.user_id
        where user.user_name LIKE CONCAT('%', #{searchInput}, '%')
    </select>
    <select id="selectFormCode"  resultType="java.lang.Integer">
        select form_code from form where form_name LIKE CONCAT('%', #{searchInput}, '%')
    </select>
    <select id="selectDeptId"  resultType="java.lang.Integer">
        select dept_id from department where dept_name LIKE CONCAT('%', #{searchDept}, '%')
    </select>



</mapper>

