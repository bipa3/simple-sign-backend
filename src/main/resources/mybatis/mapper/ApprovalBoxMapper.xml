<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitedu.bipa.simplesignbackend.mapper.ApprovalBoxMapper">
    <select id="getDocumentsByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
        ORDER BY ad.created_at DESC
        LIMIT #{itemsPerPage} OFFSET #{offset};
    </select>




    <select id="getDocCountByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
    </select>



    <select id="getSearchDocumentsByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
        AND (
        ad.approval_doc_id LIKE CONCAT('%', #{searchInput}, '%')
        OR ad.approval_doc_title LIKE CONCAT('%', #{searchInput}, '%')
        OR ad.search_contents LIKE CONCAT('%', #{searchInput}, '%')
        OR u.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR u2.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR u3.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR f.form_name LIKE CONCAT('%', #{searchInput}, '%')
        )
        ORDER BY ad.created_at DESC
        LIMIT #{itemsPerPage} OFFSET #{offset};
    </select>

    <select id="getSearchDocCountByViewItems" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
        AND (
        ad.approval_doc_id LIKE CONCAT('%', #{searchInput}, '%')
        OR ad.approval_doc_title LIKE CONCAT('%', #{searchInput}, '%')
        OR ad.search_contents LIKE CONCAT('%', #{searchInput}, '%')
        OR u.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR u2.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR u3.user_name LIKE CONCAT('%', #{searchInput}, '%')
        OR f.form_name LIKE CONCAT('%', #{searchInput}, '%')
        )
    </select>

    <sql id="commonIfConditions">
        <if test="criteria.startDate != null and criteria.endDate != null">
            <choose>
                <when test="criteria.searchDate == 'sendDate'"  >
                    AND (ad.approval_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 'arrivedDate'">
                    AND (a.user_id=#{userId} AND a.receive_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 'approvDate'">
                    AND (approval_status IN('A','R') AND a.approval_date BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
                <when test="criteria.searchDate == 'closedDate'">
                    AND (ad.end_at BETWEEN #{criteria.startDate} AND #{criteria.endDate})
                </when>
            </choose>
        </if>
        <if test="criteria.searchTitle != null and criteria.searchTitle != ''">
            AND ad.approval_doc_title LIKE CONCAT('%', #{criteria.searchTitle}, '%')
        </if>
        <if test="criteria.searchContent != null and criteria.searchContent != ''">
            AND ad.search_contents LIKE CONCAT('%', #{criteria.searchContent}, '%')
        </if>
        <if test="criteria.searchDept != null and criteria.searchDept != ''">
            AND d.dept_name LIKE CONCAT('%', #{criteria.searchDept}, '%')
        </if>
        <if test="criteria.searchWriter != null and criteria.searchWriter != ''">
            AND u.user_name LIKE CONCAT('%', #{criteria.searchWriter}, '%')
        </if>
        <if test="criteria.searchApprovUser != null and criteria.searchApprovUser != ''">
            AND (a.approval_status IN ('A', 'R') AND (u2.user_name LIKE CONCAT('%', #{criteria.searchApprovUser}, '%')
            OR u3.user_name LIKE CONCAT('%', #{criteria.searchApprovUser}, '%')))
        </if>
        <if test="criteria.searchApprovState != null and criteria.searchApprovState != ''">
            <choose>
                <when test="criteria.searchApprovState == '상신'"  >
                    AND ad.doc_status = 'W'
                </when>
                <when test="criteria.searchApprovState == '진행'">
                    AND ad.doc_status = 'P'
                </when>
                <when test="criteria.searchApprovState == '종결'">
                    AND ad.doc_status IN ('A', 'R')
                </when>
                <when test="criteria.searchApprovState == '반려'">
                    AND ad.doc_status = 'R'
                </when>
            </choose>
        </if>
        <if test="criteria.searchDocForm != null and criteria.searchDocForm != ''">
            AND f.form_name LIKE CONCAT('%', #{criteria.searchDocForm}, '%')
        </if>
        <if test="criteria.searchDocNumber > 0">
            AND ad.approval_doc_id LIKE CONCAT('%', #{criteria.searchDocNumber}, '%')
        </if>
    </sql>

    <select id="getDetailSearchDocsList" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
        <include refid="commonIfConditions"/>
        ORDER BY ad.created_at DESC
        LIMIT #{itemsPerPage} OFFSET #{offset};
    </select>

    <select id="getDetailSearchDocsCount" resultType="bitedu.bipa.simplesignbackend.model.dto.DocumentListDTO">
        SELECT DISTINCT ad.approval_doc_id, ad.approval_doc_title, ad.approval_date as sendDate, ad.org_user_id, ad.doc_status, u.user_name, d.dept_name, f.form_name, ad.end_at as end_date, u2.user_name as end_user, u3.user_name as approver
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend'">
                , a.receive_date
            </if>
            <if test="viewItem == 'concluded' ">
                , a.approval_date
            </if>
        </foreach>
        FROM approval_doc ad
        LEFT JOIN approval a ON ad.approval_doc_id = a.approval_doc_id
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'pend' || viewItem == 'concluded' || viewItem == 'reference'">
                and a.org_user_id =#{userId}
            </if>
        </foreach>
        left join approval a2 on (ad.approval_doc_id = a2.approval_doc_id and ad.approval_count = a2.approval_order and end_at is not null)
        left join approval a3 on (ad.approval_doc_id = a3.approval_doc_id and a3.approval_date = (select max(a3.approval_date) from approval) and end_at is null )
        LEFT JOIN user u ON (ad.org_user_id = u.user_id)
        left join user u2 on (a2.org_user_id = u2.user_id)
        left join user u3 on (a3.org_user_id = u3.user_id)
        JOIN organization_user ou ON ou.user_id = 1
        JOIN department d ON d.dept_id = ou.dept_id
        LEFT JOIN form f ON ad.form_code = f.form_code
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'reference'">
                join received_ref r on (r.active_state =1 and r.approval_doc_id = ad.approval_doc_id)
            </if>
        </foreach>
        WHERE ad.doc_del_status = 0
        AND (
        <foreach collection="viewItems" item="viewItem" separator="OR">
            <if test="viewItem == 'send'">
                (ad.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P', 'W'))
            </if>
            <if test="viewItem == 'tempor'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'T')
            </if>
            <if test="viewItem == 'pend'">
                (a.org_user_id = #{userId} AND a.approval_status = 'P' and (ad.doc_status != 'A' and ad.doc_status != 'R'))</if>
            <if test="viewItem == 'concluded'">
                (EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId} AND ad.doc_status IN ('A', 'R', 'P') AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'reference'">
                ((ad.doc_status != 'T' and ad.doc_status != 'P') and (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id  AND (r.use_id =#{userId} and r.category = 'U') OR (r.use_id =#{deptId} and r.category='D') OR (r.use_id = #{estId} and r.category='E') OR (r.use_id = #{compId} and r.category='C'))) )
            </if>
            <if test="viewItem == 'progress'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'P' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.user_id = #{userId} AND a.approval_status IN ('A', 'R')))
            </if>
            <if test="viewItem == 'end'">
                (ad.end_at is not null)
            </if>
            <if test="viewItem == 'reject'">
                (ad.org_user_id = #{userId} AND ad.doc_status = 'R' AND EXISTS (SELECT 1 FROM approval a WHERE a.approval_doc_id = ad.approval_doc_id AND a.org_user_id = #{userId}))
            </if>
        </foreach>
        )
        <include refid="commonIfConditions"/>;
    </select>

    <select id="selectSendCount" resultType="int">
        select count(*) from approval_doc where org_user_id = #{userId} and doc_status = 'P' and doc_del_status = 0
    </select>
    <select id="selectPendCount" resultType="int">
        select count(*) from approval_doc ad
        join approval a on a.approval_doc_id = ad. approval_doc_id
        where a.org_user_id = #{userId} and a.approval_status = 'P' and doc_del_status = 0 and (ad.doc_status != 'A' and ad.doc_status != 'R')
    </select>
    <select id="selectConcludedCount" resultType="int">
        select count(*) from approval_doc ad
        join approval a on a.approval_doc_id = ad. approval_doc_id
        where a.org_user_id = #{userId} and (a.approval_status = 'A' or a.approval_status = 'R') and doc_del_status = 0
        and ad.doc_status = 'P'
    </select>
    <select id="selectReferenceCount" resultType="int">
        SELECT COUNT(*) FROM (
        SELECT DISTINCT ad.approval_doc_id
        FROM approval_doc ad
        JOIN received_ref r ON (r.active_state =1 AND r.approval_doc_id = ad.approval_doc_id)
        LEFT JOIN doc_view dv ON (dv.approval_doc_id = ad.approval_doc_id)
        WHERE ((ad.doc_status != 'T' AND ad.doc_status != 'P') AND (EXISTS (SELECT 1 FROM received_ref r WHERE r.approval_doc_id = ad.approval_doc_id AND (r.use_id = #{userId} AND r.category = 'U') OR (r.use_id =#{deptId} AND r.category='D') OR (r.use_id = #{estId} AND r.category='E') OR (r.use_id = #{compId} AND r.category='C'))))
        AND doc_del_status = 0
        AND (dv.org_user_id IS NULL OR dv.org_user_id != #{userId})
        ) as subquery;
    </select>
    <insert id="insertDocView">
        INSERT INTO doc_view(approval_doc_id, org_user_id)
        SELECT #{docId}, #{userId}
        WHERE NOT EXISTS (
        SELECT 1
        FROM doc_view
        WHERE approval_doc_id = #{docId} AND org_user_id = #{userId}
        )
    </insert>
    <select id="selectDocView"  resultType="java.lang.Integer">
        select approval_doc_id from doc_view where org_user_id = #{userId}
    </select>

</mapper>

